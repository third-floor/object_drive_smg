<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historic Rail Explorer ðŸš‚</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js for geometry math -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: system-ui, sans-serif; }
    #map { position: absolute; top: 0; left: 300px; right: 0; bottom: 0; }
    #sidebar {
      position: absolute; top: 0; left: 0; bottom: 0; width: 300px;
      background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.15);
      overflow-y: auto; padding: 10px; z-index: 1000;
    }
    #sidebar h2 { text-align: center; }
    .train-icon {
      width: 40px; height: 40px;
      background-image: url('https://cdn-icons-png.flaticon.com/512/757/757594.png');
      background-size: contain; background-repeat: no-repeat;
      transform: rotate(0deg);
    }
    .station-label {
      font-size: 0.8em; background: white; padding: 2px 4px; border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>ðŸš‰ Nearby Objects</h2>
    <div id="info">Loading historic railway network...</div>
  </div>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([54.5, -3], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const trainIcon = L.divIcon({ className: 'train-icon' });
    let trainMarker = L.marker([54.5, -3], { icon: trainIcon }).addTo(map);
    let trainPos = { lat: 54.5, lng: -3 };
    let stations = [], railways = [], currentStation = null;
    const sidebar = document.getElementById('info');

    // --- Load Data ---
    Promise.all([
      fetch('./data/railways_1881.geojson').then(r => r.json()),
      fetch('./data/stations_1881.geojson').then(r => r.json()),
      fetch('./objects.json').then(r => r.json())
    ]).then(([railData, stationData, objects]) => {
      // Add railway lines
      L.geoJSON(railData, { color: '#666', weight: 2 }).addTo(map);

      // Add stations
      const stationLayer = L.geoJSON(stationData, {
        pointToLayer: (feature, latlng) => {
          const m = L.circleMarker(latlng, { radius: 5, color: 'red' });
          m.bindTooltip(feature.properties.name || "Station", {
            permanent: true, direction: 'right', className: 'station-label'
          });
          return m;
        }
      }).addTo(map);

      // Store data
      railways = railData.features;
      stations = stationData.features.map(f => ({
        name: f.properties.name || "Station",
        lat: f.geometry.coordinates[1],
        lng: f.geometry.coordinates[0]
      }));

      sidebar.innerHTML = `Loaded ${stations.length} stations and ${objects.length} objects.<br><br>Use arrow keys to move train along the network.`;

      // Start at nearest station
      const start = nearestStation(trainPos, stations);
      trainPos = { lat: start.lat, lng: start.lng };
      trainMarker.setLatLng(trainPos);
      currentStation = start;
      map.panTo(trainPos);

      // Key controls
      document.addEventListener('keydown', e => {
        if (["ArrowUp","w","W","ArrowDown","s","S","ArrowLeft","a","A","ArrowRight","d","D"].includes(e.key)) {
          moveTrain(objects);
        }
      });
    });

    // --- Utility: Find nearest station ---
    function nearestStation(pos, list) {
      let min = Infinity, nearest = null;
      list.forEach(s => {
        const d = map.distance([pos.lat,pos.lng],[s.lat,s.lng]);
        if (d < min) { min = d; nearest = s; }
      });
      return nearest;
    }

    // --- Train movement ---
    let moving = false;
    function moveTrain(objects) {
      if (moving) return;

      // Find connected stations by shared railway line
      const currentPoint = turf.point([currentStation.lng, currentStation.lat]);
      const nearbyStations = [];

      railways.forEach(line => {
        const lineGeom = turf.lineString(line.geometry.coordinates);
        const dist = turf.pointToLineDistance(currentPoint, lineGeom, { units: 'kilometers' });
        if (dist < 0.1) { // station is near this line
          stations.forEach(s => {
            const sp = turf.point([s.lng, s.lat]);
            const d2 = turf.pointToLineDistance(sp, lineGeom, { units: 'kilometers' });
            if (d2 < 0.1 && s.name !== currentStation.name) nearbyStations.push(s);
          });
        }
      });

      if (nearbyStations.length === 0) return;
      const nextStation = nearestStation(currentStation, nearbyStations);

      // Find path along the real rail geometry between stations
      const pathCoords = findRailPath(currentStation, nextStation);
      if (!pathCoords) return;

      const route = L.polyline(pathCoords, { color: 'blue', weight: 3 }).addTo(map);
      moving = true;
      animateTrain(pathCoords, nextStation, objects, route);
    }

    // --- Find rail path between two stations ---
    function findRailPath(stA, stB) {
      let bestLine = null, bestDist = Infinity;
      railways.forEach(line => {
        const geom = turf.lineString(line.geometry.coordinates);
        const d1 = turf.pointToLineDistance(turf.point([stA.lng, stA.lat]), geom);
        const d2 = turf.pointToLineDistance(turf.point([stB.lng, stB.lat]), geom);
        if (d1 < 0.05 && d2 < 0.05 && d1 + d2 < bestDist) {
          bestDist = d1 + d2;
          bestLine = line.geometry.coordinates;
        }
      });
      return bestLine ? bestLine.map(c => [c[1], c[0]]) : null;
    }

    // --- Animate train along real curved line ---
    function animateTrain(coords, nextStation, objects, routeLine) {
      let i = 0;
      const total = coords.length;
      const step = 2;

      const move = setInterval(() => {
        if (i >= total) {
          clearInterval(move);
          moving = false;
          trainPos = { lat: nextStation.lat, lng: nextStation.lng };
          trainMarker.setLatLng(trainPos);
          map.removeLayer(routeLine);
          currentStation = nextStation;
          showNearbyObjects(nextStation, objects);
          return;
        }
        const [lat, lng] = coords[i];
        trainMarker.setLatLng([lat, lng]);
        map.panTo([lat, lng]);
        i += step;
      }, 50);
    }

    // --- Display nearby museum objects ---
    function showNearbyObjects(station, objects) {
      const nearby = objects.filter(o => o.lat && o.lng && map.distance([station.lat, station.lng], [o.lat, o.lng]) < 24000);
      let html = `<h2>ðŸš‰ ${station.name}</h2><p>${nearby.length} objects within 15 miles:</p>`;
      nearby.slice(0, 25).forEach(o => {
        html += `<div style="margin-bottom:8px;"><b>${o.title}</b><br><i>${o.category}</i><br><small>${o.place || ''}</small></div>`;
      });
      sidebar.innerHTML = html;
    }
  </script>
</body>
</html>
