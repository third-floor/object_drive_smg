<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Historic Rail Explorer üöÜ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, sans-serif;
      background: #f8f8f8;
    }
    #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }

    .train-emoji {
      font-size: 48px;
      transform: translate(-50%, -50%);
    }

    .hud {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      z-index: 1000;
    }

    /* Loading screen */
    #loading {
      display: none;
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
    }

    #loading span {
      font-size: 64px;
      margin-bottom: 10px;
    }

    .choice-button {
      background: orange;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: 0.2s;
    }
    .choice-button:hover {
      background: darkorange;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud">
    üìç Station: <b id="stationDisplay">Loading...</b>
  </div>

  <div id="loading">
    <span>üöÜ</span>
    <div>Travelling to next station...</div>
  </div>

  <script>
    // === Map setup ===
    const map = L.map('map', { keyboard: false }).setView([53.5, -2.5], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const hudStation = document.getElementById('stationDisplay');
    const loadingScreen = document.getElementById('loading');

    const trainIcon = L.divIcon({
      className: '',
      html: '<div class="train-emoji">üöÜ</div>',
      iconSize: [48, 48],
      iconAnchor: [24, 24]
    });
    const trainMarker = L.marker([53.5, -2.5], { icon: trainIcon }).addTo(map);

    // === Data ===
    let railways = [];
    let stations = [];
    let currentStation = null;

    // === Load GeoJSON ===
    Promise.all([
      fetch('./data/railways_1881.geojson').then(r => r.json()),
      fetch('./data/stations_1881.geojson').then(r => r.json())
    ]).then(([railData, stationData]) => {
      railways = railData.features;
      stations = stationData.features.map(f => ({
        name: f.properties.name || 'Station',
        lat: f.geometry.coordinates[1],
        lng: f.geometry.coordinates[0]
      }));

      // Draw lines and stations
      L.geoJSON(railData, { color: '#555', weight: 2 }).addTo(map);

      stations.forEach(s => {
        const marker = L.circleMarker([s.lat, s.lng], {
          radius: 5,
          color: '#0077cc',
          fillColor: '#00aaff',
          fillOpacity: 0.9
        }).addTo(map).bindTooltip(s.name);
      });

      // Start game at nearest station
      const start = nearestStation({ lat: 53.5, lng: -2.5 });
      arriveAtStation(start);
    });

    // === Helpers ===
    function nearestStation(pos) {
      let min = Infinity, nearest = null;
      stations.forEach(s => {
        const d = map.distance([pos.lat,pos.lng],[s.lat,s.lng]);
        if (d < min) { min = d; nearest = s; }
      });
      return nearest;
    }

    function findConnections(station) {
      const connected = [];
      railways.forEach(line => {
        const coords = line.geometry.coordinates;
        coords.forEach((c, i) => {
          const [lon, lat] = c;
          if (map.distance([lat, lon], [station.lat, station.lng]) < 300) {
            // find nearby stations on same line
            stations.forEach(s2 => {
              if (s2 !== station) {
                const d = coords.some(([lon2, lat2]) =>
                  map.distance([lat2, lon2], [s2.lat, s2.lng]) < 300
                );
                if (d && !connected.includes(s2)) connected.push(s2);
              }
            });
          }
        });
      });
      return connected;
    }

    function arriveAtStation(station) {
      currentStation = station;
      hudStation.textContent = station.name;
      trainMarker.setLatLng([station.lat, station.lng]);
      map.setView([station.lat, station.lng], 13);

      // Offer choices
      const options = findConnections(station);
      if (options.length === 0) return;

      const choiceDiv = L.control({ position: 'topright' });
      choiceDiv.onAdd = () => {
        const div = L.DomUtil.create('div');
        div.innerHTML = `<h4>Choose your next stop:</h4>`;
        options.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'choice-button';
          btn.textContent = opt.name;
          btn.onclick = () => {
            map.removeControl(choiceDiv);
            travelToStation(opt);
          };
          div.appendChild(btn);
        });
        return div;
      };
      choiceDiv.addTo(map);
    }

    function travelToStation(nextStation) {
      loadingScreen.style.display = 'flex';
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        arriveAtStation(nextStation);
      }, 2000);
    }
  </script>
</body>
</html>
